<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/daviddong.github.io/assets/css/style.css">
<link rel="icon" href="/daviddong.github.io/assets/favicon.ico">
<title>Build TA images on different TrustZone | David Dong's Blog</title>
<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Build TA images on different TrustZone | David Dong’s Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Build TA images on different TrustZone" />
<meta name="author" content="David Dong" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This article will give a introduction on how to build TA images on different TrustZone." />
<meta property="og:description" content="This article will give a introduction on how to build TA images on different TrustZone." />
<link rel="canonical" href="http://localhost:4000/daviddong.github.io/android/fingerprint/2021/02/04/Fingerprint-build-ta.html" />
<meta property="og:url" content="http://localhost:4000/daviddong.github.io/android/fingerprint/2021/02/04/Fingerprint-build-ta.html" />
<meta property="og:site_name" content="David Dong’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-04T12:21:47+08:00" />
<script type="application/ld+json">
{"headline":"Build TA images on different TrustZone","dateModified":"2021-02-04T12:21:47+08:00","datePublished":"2021-02-04T12:21:47+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/daviddong.github.io/android/fingerprint/2021/02/04/Fingerprint-build-ta.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/daviddong.github.io/BLOG"},"name":"David Dong"},"author":{"@type":"Person","name":"David Dong"},"url":"http://localhost:4000/daviddong.github.io/android/fingerprint/2021/02/04/Fingerprint-build-ta.html","description":"This article will give a introduction on how to build TA images on different TrustZone.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->




</head>
  <body><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><main class="container">
      <section class="about">
        <a href="/daviddong.github.io/blog/index.html"><img src="/daviddong.github.io/assets/avatar.png" alt="David Dong"></a>
        <h2 id="title">
          <a href="/daviddong.github.io/blog/index.html">David Dong</a>
        </h2>
        <p class="tagline">Java/C/C#/Python</p>
        <ul class="social">
		   <a href="https://rainbow-ux.github.io/traveler-blog.github.io">
              <li>
                <i class="icon-picture-3"></i>
              </li>
           </a><a href="https://github.com/gangdong">
              <li>
                <i class="icon-github-circled-1"></i>
              </li>
            </a><a href="https://www.linkedin.com/in/刚-董-25208ba0/">
              <li>
                <i class="icon-linkedin-squared"></i>
              </li>
            </a></ul><nav class="navigation">
            <ul>
              
            </ul>
          </nav><p>&copy;
          2021</p><div>
        <p style = "font-family: Raleway, sans-serif;font-size: 100%">Dark Theme
          <i class="icon-moon"></i>
          <label class="switch">
            <input type="checkbox" id="dark-mode-toggle" onclick="toggleDarkMode()">
            <span class="slider round"></span>
          </label>
        </p>
      </div>
      <script type="text/javascript" src="/daviddong.github.io/assets/js/darkmode.js"></script><div>
        <ul class="social" style="padding-top: 3vh"><a style ="margin-right:10px;text-decoration: none;font-family: Raleway, sans-serif;" href="/daviddong.github.io/rss.xml">
              <span class="icon-rss-1">rss</span>
           </a><a style="text-decoration: none;font-family: Raleway, sans-serif;" href="https://github.com/gangdong/daviddong.github.io">
              <span class="icon-file-code">code</span>
            </a></ul>
      </div>
      </section>
      <section class="content">
        <!-- add menu bar here! -->


<div class="post-container">
<div  class = "menu">
<div  style="font-size:180%;font-weight:800; margin-top: 20px">BLOG</div>
<div  style = "margin-top: 20px">
<a class = "menu_tag_a" href="/daviddong.github.io/blog/index.html">
    <span class="icon-doc-text icon_font">Posts</span>
</a><a  class = "menu_tag_a" href="/daviddong.github.io/archive">
    <span class="icon-archive-1 icon_font">Archives</span>
</a><a  class = "menu_tag_a" href="/daviddong.github.io/category">
    <span class="icon-tags-1 icon_font">Categories</span>
</a><a  class = "menu_tag_b" href="/daviddong.github.io/about">
    <span class="icon-help-circled-3 icon_font">About</span>
</a>
</div>
</div>
</div><div class="post-container">
  <li class="posts-labelgroup" id="posts-labelgroup">
	<h1 id="posts-label">POST</h1>
  </li>  
  <a class="post-link" href="/daviddong.github.io/android/fingerprint/2021/02/04/Fingerprint-build-ta.html">
    <h2 class="post-title">Build TA images on different TrustZone</h2>
  </a>
  <div class="post-meta">
    <ul class="post-categories"><li>Android</li><li>Fingerprint</li></ul>
    <div class="post-date"><i class="icon-calendar"></i>Feb 4, 2021</div>
  </div>
  <!-- post content here! -->
  <!-- if sidebar! -->
  
  <!-- set fix width box to put content! -->
  <div class="post-viewer-container">
	<div class="post-fix-width">
		<p>This article will give a introduction on how to build TA images on different TrustZone.</p>

<h2 id="1-about-tee"><span id="1">1. About TEE</span></h2>
<p>Nowadays, any security related application must run on the TEE. TEE (Trusted Execution Environment) is able to provide a absolute-safe environment for any user security requirement. Fingerprint application as one kind of biometric authentication, it is a trusted application and must run on the TEE. Here I will take Fingerprint application as an example to introduce how to build the trusted application (TA) image.</p>

<p>Before start, I want to use below diagram for presenting a short description on how TEE works on fingerprint application. 
<img src="/daviddong.github.io/assets/image/fingerprint-build-ta-01.png" alt="fingerprint-tee" class="center-image" /></p>

<p>The main control flow, handling the various use cases, is implemented in REE (Fingerprint HAL). Images from the sensor are captured on the TEE side and managed by fingerprint library, which also coordinates data flow towards the submodules implementing various algorithms for image processing and biometric processing. Enrolled fingerprint templates are managed in a RAM database in Fingerprint TA, and encrypted before passed to REE side for persistent storage. when authentication occurred, the matcher algorithm in the TEE side will work and give the matching result to REE. The communication channel - SPI transmission is physical in TEE and normally works by calling TEE API.</p>

<p>The software module working on TEE side are normally built into a binary file, which runs on the TEE OS as an executable application (Trusted Application). Different TEE OS can support different number of Trusted Application (TA).</p>

<p>There are multiple commercial TEE OS on the Android platform supported by the third-part companies, some popular ones among them are QSEE, ISEE, Trusty. The following content will introduce how the fingerprint TA image is built out on these TEE OS.</p>

<h2 id="2-qsee-5"><span id="2">2. QSEE 5</span></h2>
<p>QSEE is one TEE OS supported by Qualcomm. In android market, system running with Qualcomm platform uses the QSEE Trustzone. QSEE provides a set of SDK that help the developer to develop the TEE application and generate the image file (TA image).</p>

<h3 id="21-sdk-"><span id="2.1">2.1 SDK </span></h3>
<p>To build the TA image, we need to use QSEE SDK, which can be got from Qualcomm or ODMs. Here I use QSEE5 SDK and put it to below location in my unbuntu.</p>

<p><code class="language-plaintext highlighter-rouge"> /home/david/devtools/tz_qsee5 </code></p>
<h3 id="22-fingerprint_ta-code-"><span id="2.2">2.2 Fingerprint_TA code </span></h3>
<p>Next we need to put the source code of Fingerprint TA into place that the SDK can find it and make.
In QSEE, normally there is specific location in the SDK file tree for storing the TA code.  <br />
It is at 
<code class="language-plaintext highlighter-rouge">/home/david/devtools/tz_qsee5/ssg/securemsm/trustzone/qsapps/</code></p>

<h3 id="23-build-command-"><span id="2.3">2.3 Build command </span></h3>
<p>We executes the build command to make the TA code and generate the TA image.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="n">cd</span> <span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">tz_qsee5</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">ms</span><span class="o">/</span>
 <span class="n">python</span> <span class="n">build_all</span><span class="p">.</span><span class="nf">py</span> <span class="o">-</span><span class="n">b</span> <span class="no">TZ</span><span class="o">.</span><span class="no">XF</span><span class="o">.</span><span class="mf">5.0</span><span class="o">.</span><span class="mi">1</span> <span class="no">CHIPSET</span><span class="o">=</span><span class="n">sdm845</span> <span class="o">--</span><span class="n">cbt</span><span class="o">=</span><span class="s2">"$(FPC_CONFIG_TZ_IMAGE_NAME)"</span> <span class="err">$</span><span class="p">(</span><span class="n">build_flags</span><span class="p">)</span></code></pre></figure>

<p>Build process
<img src="/daviddong.github.io/assets/image/fingerprint-build-ta-02.png" alt="fingerprint-tee" class="center-image" /></p>

<h3 id="24-ta-image-"><span id="2.4">2.4 TA image </span></h3>
<p>TA images are generated at 
<code class="language-plaintext highlighter-rouge">/home/david/devtools/tz_qsee5/build/ms/bin/PIL_IMAGES/SPLITBINS_WAXAANAA/</code></p>

<p>The TA images are</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b00</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b01</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b02</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b03</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b04</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b05</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b06</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">b07</span>
<span class="n">fpctzappfingerprint</span><span class="p">.</span><span class="nf">mdt</span></code></pre></figure>

<h2 id="3-isee-"><span id="3">3. ISEE </span></h2>
<p>There is no property TEE OS under MTK platform. It adopts the way of integrating the TEE environment of a third party. The common TEE manufacturers ISEE.</p>

<h3 id="31-sdk-"><span id="2.1">3.1 SDK </span></h3>

<p>For ISEE SDK, it can find more details on this link <a href="https://www.beanpodtech.com/%e4%b8%bb%e8%a6%81%e4%ba%a7%e5%93%81/isee-sdk/">「ISEE SDK」</a>
I put the SDK into below location.
<code class="language-plaintext highlighter-rouge">/home/david/devtools/isee_sdk_270</code></p>
<h3 id="32-fingerprint_ta-code-"><span id="3.2">3.2 Fingerprint_TA code </span></h3>
<p>Put the TA source code to below path 
<code class="language-plaintext highlighter-rouge">/home/david/devtools/platforms/mt6797/vendor/fingerprints/</code></p>
<h3 id="33-build-command-"><span id="3.3">3.3 Build command </span></h3>
<p>Run command</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="n">cd</span> <span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">isee_sdk_270</span>
 <span class="n">source</span> <span class="n">setenv</span><span class="p">.</span><span class="nf">sh</span> 
 <span class="n">cd</span> <span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">platforms</span><span class="o">/</span><span class="n">mt6797</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">fingerprints</span><span class="o">/</span><span class="n">fingerprint_ta</span><span class="o">/</span><span class="n">secure</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">isee</span>
 <span class="n">make</span></code></pre></figure>

<p>Build process
<img src="/daviddong.github.io/assets/image/fingerprint-build-ta-03.png" alt="fingerprint-tee" class="center-image" /></p>
<h3 id="34-ta-image-"><span id="3.4">3.4 TA image </span></h3>
<p>TA image is generated at path</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">platforms</span><span class="o">/</span><span class="n">mt6797</span><span class="o">/</span><span class="n">vendor</span><span class="o">/</span><span class="n">fingerprints</span><span class="o">/</span><span class="n">fingerprint_ta</span><span class="o">/</span><span class="n">secure</span><span class="o">/</span><span class="n">platform</span><span class="o">/</span><span class="n">isee</span><span class="o">/</span><span class="n">obj</span><span class="o">/</span><span class="mi">7778</span><span class="n">c03fc30c4dd0a319ea29643d4d4b</span><span class="p">.</span><span class="nf">ta</span></code></pre></figure>

<p>It uses the UUID of the TA as the TA name, which is UUID.ta</p>

<h2 id="4-trusty-"><span id="4">4. Trusty </span></h2>

<p>Trusty TEE is originated and supported by Google, which is integrated into the android as a secure Operating System (OS) that provides a Trusted Execution Environment (TEE).
For more details about Trusty, please refer to  <a href="https://source.android.com/security/trusty">「Trusty TEE」</a></p>
<h3 id="41-sdk-"><span id="4.1">4.1 SDK </span></h3>
<p>Find a location in your local device.
For example, I put the trusty SDK here.
<code class="language-plaintext highlighter-rouge">/home/david/devtools/trusty_sdk</code></p>
<h3 id="42-fingerprint_ta-code-"><span id="4.2">4.2 Fingerprint_TA code </span></h3>
<p>Copy the TA source code to the SDK folder.
<code class="language-plaintext highlighter-rouge">/home/david/devtools/trusty_sdk/app/demo/</code></p>
<h3 id="43-build-command-"><span id="4.3">4.3 Build command </span></h3>
<p>Run command</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"> <span class="n">cd</span> <span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">trusty_sdk</span>
 <span class="n">make</span> <span class="no">M</span><span class="o">=</span><span class="s2">"app/demo/fpctzapp:TA"</span></code></pre></figure>

<p>Build process
<img src="/daviddong.github.io/assets/image/fingerprint-build-ta-04.png" alt="fingerprint-tee" class="center-image" /></p>
<h3 id="44-ta-image-"><span id="4.4">4.4 TA image </span></h3>
<p>The TA image is generated at below location after compiling completed.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">trusty_sdk</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">user_tasks</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">fpctzapp</span><span class="o">/</span><span class="n">fpctzapp</span><span class="p">.</span><span class="nf">elf</span>
<span class="sr">/home/</span><span class="n">david</span><span class="o">/</span><span class="n">devtools</span><span class="o">/</span><span class="n">trusty_sdk</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">user_tasks</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">demo</span><span class="o">/</span><span class="n">fpctzapp</span><span class="o">/</span><span class="n">fpctzapp</span><span class="p">.</span><span class="nf">elf</span><span class="o">/</span><span class="n">fpctzapp</span><span class="p">.</span><span class="nf">syms</span><span class="p">.</span><span class="nf">elf</span> <span class="p">(</span><span class="err">带符号表，用于</span><span class="n">debug</span><span class="p">)</span></code></pre></figure>

<p>It uses the TA name that defined at the configuration as the image name, which is TA_Name.elf. 
Such as fpctzapp.elf. The TA_Name.syms.elf is the image file that containing the symbols table which can be used for debugging purpose.</p>


	</div>
	<!-- put sidebar! -->
	<div class="post-index-container">
		<li class = "post-index">On this page</li>
		<li><ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#1-about-tee">1. About TEE</a></li>
<li class="toc-entry toc-h2"><a href="#2-qsee-5">2. QSEE 5</a>
<ul>
<li class="toc-entry toc-h3"><a href="#21-sdk-">2.1 SDK </a></li>
<li class="toc-entry toc-h3"><a href="#22-fingerprint_ta-code-">2.2 Fingerprint_TA code </a></li>
<li class="toc-entry toc-h3"><a href="#23-build-command-">2.3 Build command </a></li>
<li class="toc-entry toc-h3"><a href="#24-ta-image-">2.4 TA image </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#3-isee-">3. ISEE </a>
<ul>
<li class="toc-entry toc-h3"><a href="#31-sdk-">3.1 SDK </a></li>
<li class="toc-entry toc-h3"><a href="#32-fingerprint_ta-code-">3.2 Fingerprint_TA code </a></li>
<li class="toc-entry toc-h3"><a href="#33-build-command-">3.3 Build command </a></li>
<li class="toc-entry toc-h3"><a href="#34-ta-image-">3.4 TA image </a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#4-trusty-">4. Trusty </a>
<ul>
<li class="toc-entry toc-h3"><a href="#41-sdk-">4.1 SDK </a></li>
<li class="toc-entry toc-h3"><a href="#42-fingerprint_ta-code-">4.2 Fingerprint_TA code </a></li>
<li class="toc-entry toc-h3"><a href="#43-build-command-">4.3 Build command </a></li>
<li class="toc-entry toc-h3"><a href="#44-ta-image-">4.4 TA image </a></li>
</ul>
</li>
</ul></li>
	</div>
  </div>
  <!-- no sidebar, use flex width box! -->
  

  <br><br><br>
  <!-- Page navigation start here! --><li class="posts-labelgroup" id="posts-labelgroup">
	<h1 id="posts-label">further reading</h1>
  </li> 
  <div class="navigation-meta" style = "margin-bottom:40px"><ul class="navigation-bar" style = "margin-top:40px; min-width:40%">   
	 <a href="/daviddong.github.io/android/fingerprint/2020/12/02/Fingerprint-Trusty.html"; style="width:100%"><font size="1px" color="#777">Previous Post</font><br>Some useful knowledge for Fingerprint Application on Trusty TEE</a>
    </ul><ul class="navigation-bar" style = "margin-top:40px; min-width:40%">   
     <a href="/daviddong.github.io/web/2021/03/08/Web-gitalk-fixing.html"; style="width:100%"><font size="1px" color="#777">Next Post</font><br>A quick way to fix the Gitalk Error: Validation Failed</a>
    </ul></div><br>
  <!-- comment box starts here! -->
    <!-- disqus start  --><!-- Gitalk start  -->
  <!-- Link Gitalk support file  -->
  <section class="gitalk">
  <div id="gitalk_thread"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script type="text/javascript" src="/daviddong.github.io/assets/js/md5.min.js"></script>
  <div id="gitalk-container"></div>
  <script type="text/javascript">
   var gitalk = new Gitalk({
   // gitalk parameters
   clientID: '5e24fc307693a6df3bc5',
   clientSecret: '28c9c17e1174c705c42e9bdc92f87cadcc4ec8b8',
   repo: 'daviddong.github.io',
   owner: 'gangdong',
   admin: ['gangdong'],
   id: md5(location.pathname),
   title: 'comments'
    });
   gitalk.render('gitalk-container');
  </script>
  </section>
  <!-- Gitalk end -->
  <br/><br/><br/><div class = "footer">© 2012-2021 David Dong. All rights reserved.</div>
  
  <br>
</div>

      </section>
    </main>
<script src="/daviddong.github.io/assets/js/simple-jekyll-search.min.js"></script>
<script src="/daviddong.github.io/assets/js/search.js"></script>
<link href="/daviddong.github.io/assets/css/vim.css" rel="stylesheet"/>

  </body>
</html>
